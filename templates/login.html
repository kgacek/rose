<!DOCTYPE html>
<html>
<head>
    <title>Facebook Login JavaScript Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
</head>
<body>
<script type=text/javascript src="/static/js/jquery.js"></script>
<script>

    var waitForGlobal = function (callback) {
        if (typeof fb_user_psid !== 'undefined') {
            callback();
        } else {
            setTimeout(function () {
                waitForGlobal(callback);
            }, 200);
        }
    };

    function genTable(data) {
        var myTable = document.getElementById('myTable');
        while (myTable.firstChild) {
            myTable.removeChild(myTable.firstChild);
        }
        var row = document.createElement("TR");
        var tbody = document.createElement("TBODY");
        var thead = document.createElement("THEAD");
        var cell = document.createElement("TH");
        cell.innerText = "patron";
        row.appendChild(cell);
        cell = document.createElement("INPUT");
        cell.name="user_psid";
        cell.value=fb_user_psid;
        cell.style.display = 'none';
        row.appendChild(cell);
        cell = document.createElement("TH");
        cell.innerText = "nr taj.";
        row.appendChild(cell);
        thead.appendChild(row);
        for (intention in data) {
            row = document.createElement("TR");
            cell = document.createElement("TD");
            cell.innerText = intention;
            cell.colSpan = "2";
            row.appendChild(cell);
            tbody.appendChild(row);
            row = document.createElement("TR")

            var select = document.createElement('select');
            select.name=intention;
            select.style.width= '100%';
            for (rose in data[intention]) {
                var option = document.createElement('option');
                option.value = data[intention][rose];
                option.text = data[intention][rose];
                select.appendChild(option);
            }
            cell = document.createElement("TD");
            cell.appendChild(select);
            row.appendChild(cell);
            cell = document.createElement("TD");
            var x = document.createElement("INPUT");
            x.setAttribute("type", "number");
            x.setAttribute("maxlength", '2');
            x.style.width = "3em";
            x.min='1';
            x.max='20';
            x.required = true;
            x.name=intention+"_mystery";
            cell.appendChild(x);
            row.appendChild(cell);
            tbody.appendChild(row);

        }
        myTable.appendChild(thead);
        myTable.appendChild(tbody);
    }

    function already_user() {
        $.getJSON("https://kgacek.pythonanywhere.com/_get_users_intentions", {
            user_psid: fb_user_psid
        }, function (data) {
            if (Object.keys(data).length > 0) {
                document.getElementById('statusTitle').innerText = 'Wybierz Patrona i aktualnie odmawianą tajemnicę dla każdej róży w której uczestniczysz:';
                document.getElementById('myForm').style.display = 'block';
                genTable(data);
            } else {
                document.getElementById('statusTitle').innerText = 'Nie Jesteś zapisany do żadnej Intencji lub już wcześniej skonfigurowałeś swoje konto!';
                setTimeout(function () {
                    MessengerExtensions.requestCloseBrowser();
                }, 3000);
            }

        });

    }

    function new_user() {
        $.getJSON("https://kgacek.pythonanywhere.com/_set_user_status_to_verified", {
            user_psid: fb_user_psid
        }, function () {
            MessengerExtensions.requestCloseBrowser();
        });
    }

    function statusChangeCallback(response) {
        console.log('statusChangeCallback');
        if (response.status === 'connected') {
            waitForGlobal(function () {
                document.getElementById('statusTitle').innerText = 'Logowanie się powiodło';
                document.getElementById('loginBtn').style.display = 'none';
                FB.api("/" + response.authResponse["userID"] + "/groups", {access_token: response.authResponse["accessToken"]}, function (response2) {
                    if (response2 && !response2.error)
                        var data_json = JSON.stringify([response2, response.authResponse["userID"], fb_user_psid], null, '\t');
                    console.log(data_json);
                    $.ajax({
                        url: "https://kgacek.pythonanywhere.com/login",
                        method: "post",
                        contentType: 'application/json;charset=UTF-8',
                        data: data_json
                    }).always(function () {
                        document.getElementById('choice_buttons').style.display = 'block';
                    });
                });
            });
        } else {
            document.getElementById('statusTitle').innerText = 'Zaloguj się do aplikacji, aby wczytać intencje do których należysz i ustawić aktualną tajemnicę.';
            document.getElementById('loginBtn').style.display = 'block';
        }
    }

    function loginbutton() {
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });
    }

    window.extAsyncInit = function () {
        // the Messenger Extensions JS SDK is done loading
        MessengerExtensions.getContext('1061023747434571',
            function success(thread_context) {
                fb_user_psid = thread_context.psid
                // success
            }
        );
    };

    window.fbAsyncInit = function () {
        FB.init({
            appId: '1061023747434571',
            cookie: true,  // enable cookies to allow the server to access
                           // the session
            xfbml: true,  // parse social plugins on this page
            version: 'v3.2' // use graph api version 2.8
        });
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });

    };

    // Load the SDK asynchronously
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/messenger.Extensions.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'Messenger'));
</script>
<h4 id="statusTitle">Uruchamiam aplikację..</h4>
<div class="fb-login-button" data-size="large" data-button-type="login_with" data-auto-logout-link="true" data-use-continue-as="true" data-onlogin="loginbutton()" style="display: none;" id="loginBtn"></div>

<form id="myForm" action="https://kgacek.pythonanywhere.com/_get_users_intentions" method="post" style='display: none'>
<table id="myTable" class="iTable"></table> <br>
  <input type="submit" value="Zapisz" class="myButton" style="float: right;"><br>
</form>
<hr>
<div id="choice_buttons" style="display: none;">
    <h4 id="statusTitle">Czy miałeś już przypisaną tajemnice?</h4>
    <a href="#" onclick="already_user()" class="myButton">TAK</a>
    <a href="#" onclick="new_user()" class="myButton">NIE</a>
</div>

</body>
</html>